<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="generator" content="TiddlyWiki" />
<meta name="tiddlywiki-version" content="5.1.22" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="format-detection" content="telephone=no">
<link id="faviconLink" rel="shortcut icon" href="favicon.ico">
<link rel="stylesheet" href="static.css">
<title>git/Remove-History: My Struggle — Life goes on...</title>
</head>
<body class="tc-body">

<section class="tc-story-river">
<p><div class="tc-tiddler-frame tc-tiddler-view-frame tc-tiddler-exists " data-tags="" data-tiddler-title="git/Remove-History"><div class="tc-tiddler-title"><div class="tc-titlebar"><span class="tc-tiddler-controls"><span class=" tc-reveal"><button aria-label="more" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fmore-tiddler-actions" title="More actions"></button><div class=" tc-reveal" hidden="true"></div></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal"><button aria-label="edit" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fedit" title="Edit this tiddler"></button></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal"><button aria-label="close" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fclose" title="Close this tiddler"></button></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span></span><span><span class="tc-tiddler-title-icon" style="fill:;"></span><h2 class="tc-title">git/Remove-History</h2></span></div><div class="tc-tiddler-info tc-popup-handle tc-reveal" hidden="true"></div></div><div class=" tc-reveal" hidden="true"></div>
<div class=" tc-reveal"><div class="tc-subtitle"><a class="tc-tiddlylink tc-tiddlylink-missing" href=".html"></a>26th July 2020</div></div><div class=" tc-reveal">
<div class="tc-tags-wrapper"></div>
</div>

<div class="tc-tiddler-body tc-reveal"><hr><p>title: Git - 删除 Git Commit 历史记录<br>date: 2019-12-14<br>edit: 2019-12-14<br>layout: post<br>status: Completed<br>categories:</p><ul><li><p>Git<br>tags:</p></li><li><p>Git<br>description: 绕开这个问题好久了, 一直对删除心有余悸, 至今其实也不能完全应对, 但至少进步了点, 稍微理解了点 <a href="https://git-scm.com/docs/git-reset" target="_blank">git reset</a>, <a href="https://git-scm.com/docs/git-reset" target="_blank">git revert</a></p></li></ul><hr><h1>背景</h1><p>常在河边走, 难免不湿鞋, Git 虽然操作不多, 但错误接二连三, 其中最逃避的就是 回滚, 提交错了想回退, 战战兢兢不敢 hard 模式, 以至于 commit history 总是夹杂着问题.</p><h2>问题重现</h2><p>需要 删除历史记录的情况很多, 比如 删本地的, 删远程的我也没都遇到过, 也没都能尝试, 仅就自己遇到的先写点, 以后再慢慢增补</p><p>我遇到的多是:</p><ul><li><p>本地 git add 后, 后悔了 (这个最简单了)</p></li><li><p>本地 git ci 后, 后悔了</p></li><li><p>本地 git pu 后, 后悔了</p></li></ul><p>本文题目是 删除历史记录, 就是已经commit过了的, 不过也捎带提一下还没commit的, 这个比较简单.</p><h2>分析</h2><p>现在了解到, 基本上有 3 个命令相关:</p><ul><li><p><a href="https://git-scm.com/docs/git-reset" target="_blank">git reset</a>,</p><ul><li><p>有多种模式, 比如soft/hard/mixed...</p></li><li><p>这个主要是对尚未提交的, 你本地的working tree的改动</p></li><li><p>当然, 也可以用于远程, 比如想将远程的 commit 历史中的某些commit完全删掉, 不留一丝痕迹, 我现在主要用这个的hard模式</p><ul><li><p>比如你不小心将密码 token啥的上传了, 这个就必要了</p></li></ul></li></ul></li><li><p><a href="https://git-scm.com/docs/git-revert" target="_blank">git revert</a></p><ul><li><p>这个主要是针对已经提交了的commit</p></li><li><p>比较温和, 不会删除原来的历史, 只删除代码改动部分</p></li><li><p>同时, 会生成一个新的commit记录(当然, 你也可以用 -n 参数选择不生成)</p></li></ul></li><li><p><a href="https://git-scm.com/docs/git-restore" target="_blank">git restore</a></p><ul><li><p>这个我还没用过, 是说如果你想从另一个commit里面提取某个文件, 这里先不去探索了</p></li></ul></li></ul><h2>git add 后回滚</h2><blockquote><p>尚未commit</p></blockquote><p>用的命令 <code>git reset</code>, 因为还没提交, 所以它回退的是你的本地working tree 里面,</p><ul><li><p>直接 <code>git reset --hard</code> 删除全部改动, 小心着用哦</p></li><li><p>`git reset --soft`` 温和点, 保留你的改动, 改好再提交, 具体原理参见下面的</p></li></ul><h2>git commit 后回滚</h2><blockquote><p>尚未push</p></blockquote><p>做了某个提交:</p><pre><code>git add .
git ci -m &quot;test git reset after commit&quot;
</code></pre><p>之后, 想撤回来:</p><ul><li><p>如果还想保留之前的更改, 即在之前的更改基础上继续改, 那么温和一点:</p></li></ul><pre><code>git reset --soft &lt;想撤回到的commit_id&gt;
</code></pre><p>这里的 &lt;想撤回到的commit_id&gt; 可以是 HEAD~3, 或者 HEAD^ 等等,视情况了</p><p>Git 做了啥事呢, 保留了你之前的更改, git现在 在等你继续改</p><p>现在到 <code>.git</code> 目录下会看到两个相关的文件:</p><ul><li><p>ORIG_HEAD, 这个是从 HEAD 文件复制过来的</p></li></ul><p>这里面存的是一个 Head 指针, 指向的是(你做过的那个提交id, 虽然现在被撤回了, 但是记录在这里以备后用), 比如这样子:</p><pre><code>b0c7fa87481d33f5277e49e0e92373aa50a4dc58

</code></pre><ul><li><p>COMMIT_EDITMSG<br>这里面是保存了你刚才reset的commit的msg, 即<code>test git reset after commit</code><br>为啥要有这个文件? 因为git想方便你修改后继续用这个msg提交, 当然你也可以替换掉用新的</p></li></ul><p>这时候如果你去看 <code>git log</code>, 会发现你的那个id已经不见了, 因为隐退了.</p><p>做完必要的代码改动后, 现在你觉得可以真正提交了, 那就:</p><pre><code>git commit -a -c ORIG_HEAD
</code></pre><p>可能会提示你merge, 继续操作就好了.</p><p>再去看 <code>git log</code>, 你先前的 commit msg 又出来了, 只是这次的 commit id不同了. 不过你新的更改都在了</p><ul><li><p>如果不想保留原来的更改,</p></li></ul><pre><code>git reset --hard  &lt;想撤回到的commit_id&gt;
git push -f origin &lt;branch_name&gt;
</code></pre><p>这个就强了, &lt;想撤回到的commit_id&gt; 这个之前的所有commit都么了.</p><h2>git push 后回滚</h2><p>建议是用 <code>git revert</code>, 因为这个不会删除以前的 commit 历史记录, 只是删除更改的内容; (协作开发比较多用), 方便别人回溯历史吧.</p><p>一般默认会生成一个新的commit, 但也可以选择不生成, 就默默的在后台做好就好, 参考参数 <code>-no-commit</code></p><p>如果要彻底某些删除 commit 历史, 可以用前面说的 <code>git reset</code>, 比如一些隐私信息不小心上传了.</p><h2>思考</h2><ul><li><p>为什么一个功能要设计这么多命令, 挺烦人的</p></li><li><p>大概是场景太多了, 如果用一个命令多个参数区分可否?</p></li><li><p>删除这种操作总是听着危险的, 以后能少用则少用啊啊啊啊</p></li></ul><h2><a class="tc-tiddlylink tc-tiddlylink-missing" href="ChangeLog.html">ChangeLog</a></h2><ul><li><p>2019-12-14 init</p></li></ul></div>



</div>

</p>
</section>
</body>
</html>
