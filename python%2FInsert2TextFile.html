<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="generator" content="TiddlyWiki" />
<meta name="tiddlywiki-version" content="5.1.22" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="format-detection" content="telephone=no">
<link id="faviconLink" rel="shortcut icon" href="favicon.ico">
<link rel="stylesheet" href="static.css">
<title>python/Insert2TextFile: My Struggle — Life goes on...</title>
</head>
<body class="tc-body">

<section class="tc-story-river">
<p><div class="tc-tiddler-frame tc-tiddler-view-frame tc-tiddler-exists " data-tags="" data-tiddler-title="python/Insert2TextFile"><div class="tc-tiddler-title"><div class="tc-titlebar"><span class="tc-tiddler-controls"><span class=" tc-reveal"><button aria-label="more" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fmore-tiddler-actions" title="More actions"></button><div class=" tc-reveal" hidden="true"></div></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal"><button aria-label="edit" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fedit" title="Edit this tiddler"></button></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal"><button aria-label="close" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fclose" title="Close this tiddler"></button></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span></span><span><span class="tc-tiddler-title-icon" style="fill:;"></span><h2 class="tc-title">python/Insert2TextFile</h2></span></div><div class="tc-tiddler-info tc-popup-handle tc-reveal" hidden="true"></div></div><div class=" tc-reveal" hidden="true"></div>
<div class=" tc-reveal"><div class="tc-subtitle"><a class="tc-tiddlylink tc-tiddlylink-missing" href=".html"></a>26th July 2020</div></div><div class=" tc-reveal">
<div class="tc-tags-wrapper"></div>
</div>

<div class="tc-tiddler-body tc-reveal"><hr><p>title: Python - 文本文件中如何插入内容<br>date: 2019-04-23<br>edit: 2019-05-11<br>layout: post<br>categories:</p><ul><li><p>Python<br>tags:</p></li><li><p>Python<br>description:  对文本文件进行读写追加很简单, 但插入或替换内容就不方便了, 本文探讨了几种方法, 学习了模板思维, 往大处想.</p></li></ul><hr><h1>Python: 在文本文件中插入内容</h1><p>文本文件的操作用的比较多的, 读\写\追加, 通常都是在末尾追加.</p><p>如何在我们需要的某一处<strong>插入</strong>新的内容呢?</p><p>这个需求最早是在怼周刊的自动化时遇到, 当时的需求是:</p><ul><li><p>将 .txt 文件的内容读出来</p></li><li><p>然后插入到 .md 文件中的 Progress 部分</p></li></ul><p>当时用了 <a href="https://docs.python.org/2/library/fileinput.html" target="_blank">fileinput — Iterate over lines from multiple input streams</a> 模块, 使用还算方便, 因为只有一处需要替换.</p><p>后来又在蟒营的 <a class="tc-tiddlylink tc-tiddlylink-missing" href="PoW.html">PoW</a> 蟒通证的工具中, 遇到类似需求:</p><ul><li><p>将收集来的数据分别插入 .md 文件的各个指定位置</p></li></ul><p>本想继续用 fileinput, 试了一下, 发现不方便了, 因为 fileinput 需要指定原文件中的placeholder文本, 一旦这个文本内容变化了, 而且非常可能变化, 就需要调整脚本.</p><p>想到大妈有批量生成过学员邮件内容, 便想看一下高手是咋处理的, 然后果然思路不一样, 便有了此文.</p><h2>Python自带: fileinput</h2><blockquote><p><a href="https://docs.python.org/2/library/fileinput.html" target="_blank">fileinput — Iterate over lines from multiple input streams</a></p></blockquote><p>这个和<a href="https://docs.python.org/2/library/functions.html#open" target="_blank">open()</a>有什么区别?</p><ul><li><p>open(): 常规的文件读写追加</p></li><li><p>fileinput: 可以逐行 loop 文件, 显然, 如果我们想在某处插入点新内容, 当扫描到那行时, 便可以操作了.</p><ul><li><p>比如, 可以将每一行缩进几个空格</p></li><li><p>删除某行,</p></li><li><p>修改某行的内容<br>-....</p></li></ul></li></ul><p>看一个简单的例子: 将每行都加入列表符</p><p>原文件内容:</p><pre><code>Monday
Tuesday
Friday
</code></pre><p>代码:</p><pre><code>def process(line):
    print( &quot;- &quot; + line)

for line in fileinput.input(files=filename, inplace=True):
    process(line)
</code></pre><p>运行后文件内容便是这样了:</p><pre><code>- Monday
- Tuesday
- Friday
</code></pre><p>具体用法请参考官网链接<a href="https://docs.python.org/2/library/fileinput.html" target="_blank">fileinput</a>, 注意这个 inplace=True 参数, 如果要内容改动生效的话.</p><p>现在我们来看, 如何在指定位置插入内容.</p><p>假如我们想在这个文件:</p><pre><code>Time log:
&gt; Insert time log for this week below:

Actions:
- Getup and run
</code></pre><p>中的 Time Log 下面插入以下实际运行的数据:</p><pre><code>Reading 1h
Writing 1.5h
</code></pre><p>用 fileinput 可以这样来:</p><pre><code>placeholder = &quot;&gt; Insert time log for this week below&quot;

with fileinput.input(files=filename, inplace=True) as f:
    for line in f:
        print(line, end='')      &lt;------------
        if line.startswith(placeholder):
            print(txt2insert, end='\n')
</code></pre><p>需要注意的是 这行 <code>print(line, end='')</code>可不能漏了, 不然文件中的逐行扫过去的内容, 如果不符合条件的, 就被清空了.</p><h2>string formatting</h2><blockquote><p><a href="https://docs.python.org/2/library/stdtypes.html#string-formatting" target="_blank">Built-in Types — Python 2.7.16 documentation</a></p></blockquote><p>在介绍大妈的方法之前, 先回顾一下 python 中的 &quot;str&quot;.format 方法:</p><p>占位符 <code>{}</code>中的值在运行时会替换为 format 方法中的变量值 (username)</p><pre><code>str = &quot;Hello {}&quot;.format(username)
</code></pre><p>这样, 我们可以动态的传入任意 username.</p><p>例子中的字符串很短, 想象一下, 如果:</p><ul><li><p>要动态传入多个变量呢?</p></li></ul><p>自然可以这样:</p><pre><code>str = &quot;Hello {}, today is {}&quot;.format(username, week)
</code></pre><p>想一下, 如果占位符很多的情况, 比如这样:</p><pre><code>str = &quot;Hello {}, today is {}, it is {} now, it's time to {}&quot;.format(username, week, datetime, study)
</code></pre><p>是不是看的眼花了, 读起来不甚友好, python 有个解决方法:</p><ul><li><p>我们可以将所有变量放到一个字典中</p></li><li><p>在占位符中显性给个名字</p></li></ul><p>即: (为了缩短篇幅, 咱以两个变量为例)</p><pre><code>name = &quot;sir&quot;
week = &quot;Monday&quot;
data = {&quot;name&quot;: name, &quot;week&quot;:week}
print(data)
str = &quot;Hello {name}, today is {week}&quot;.format(**data)
</code></pre><p>这样舒服了.</p><p>继续, 如果是个更长\更多动态变量的情况呢? 再假设这个字串可能会被重复使用呢?</p><p>这么长且常用的字串一般如何存储? 通常是会放到文件中吧.</p><p>这样想来, 我们便离大妈的方法近了.</p><h2>模板</h2><p>现在介绍大妈的方法, 没错, 就是标题上写的模板.</p><ul><li><p>将要进行替换处理的原字符串放到一个模板文件中, 比如命名为 blah_tpl.md</p></li><li><p>在模板文件中, 将要处理的字串中的各个位置, 用占位符{git-it-a-name}</p></li></ul><p>然后:<br>- 读取模板文件内容<br>- 用 <code>文件内容.format(**_dict)</code></p><p>具体就不展开了, 上面的string formatting部分已经介绍过了, 更多细节详见官网.</p><h2>Web 模板</h2><p>还没结束, 有没有觉得上面的模板方法很眼熟?</p><p>学 python 框架的时候, 前端的渲染咱们都接触过 <a href="http://jinja.pocoo.org/" target="_blank">Jinja2 (The Python Template Engine)</a></p><p><img src="https://ws2.sinaimg.cn/large/006tNc79ly1g2cyjmg0m8j30qg07nmxu.jpg" title="image-20190423225513081"></p><p>上面这段便是 Jinja 的模板文件样例, 其中的<code>{ user.username }</code>虽然长得不太一样, 但是很相像不是?<br>虽然没看过 Jinja 源码, 不知道其背后的实现逻辑(比如是否也是用的 &quot;str&quot;.format?), 但其设计思想想来是相通的.</p><p>Note: 原谅我把 jinja 模板中的 % 都去掉了, 因为上传此文到 我的jekyll blog时, 总是 build 失败 <code>unknown tag extends</code><br>, 原因是上面引用的 jinja 模板中用到了 <code>% extends</code>, 被 jekyll 当做自己的关键词了...看来模板也有局限性的, 如何 在模板中 escape 这种关键词呢??</p><h3>Update on 2019-05-11:</h3><p>解决前面提到的 jinja 模板引用遇到的关键词 escape 问题:</p><p>在 <a href="http://jinja.pocoo.org/docs/2.10/templates/" target="_blank">Jinja 的官网</a>中看到,</p><pre>For bigger sections, it makes sense to mark a block raw. For example, to include example Jinja syntax in a template, you can use this snippet:
</pre><pre><code>{% raw %}
    &lt;ul&gt;
    {% for item in seq %}
        &lt;li&gt;{{ item }}&lt;/li&gt;
    {% endfor %}
    &lt;/ul&gt;
{% endraw %}
</code></pre><p>这样, 就可以在 markdown 或其他页面里面引用 jinja 模板内容作为示例了.</p><h2>再进一步</h2><p>现在我们用到了, 模板文件中设置 placeholder, 代码中将一段字符串插入 placeholder 中.</p><p>再往大处想, placeholder 可容纳的内容是不是可以更大更多, 不只是一串字符串, 而是一大长长串字符串呢? 那会是种什么情况? 显然, 另一个文件的内容就是其中一种情况. 这样, 合并拼接文件也变得可能了.</p><p>这个启发源自大妈的回复:</p><p><a href="https://github.com/DebugUself/du4proto/issues/657" target="_blank">5d[分享][讨论] Python 中如何向文本文件中插入/替换内容 </a></p><h2>再再进一步</h2><ul><li><p>Learn <a href="https://fengsp.github.io/blog/2016/8/how-a-template-engine-works/" target="_blank">How a template engine works — Shipeng Feng's Writings</a></p></li></ul><h2>参考</h2><ul><li><p><a href="https://docs.python.org/2/library/fileinput.html" target="_blank">fileinput — Iterate over lines from multiple input streams</a></p></li><li><p><a href="https://docs.python.org/2/library/stdtypes.html#string-formatting" target="_blank">Built-in Types — Python 2.7.16 documentation</a></p></li><li><p><a href="http://jinja.pocoo.org/" target="_blank">Jinja2 (The Python Template Engine)</a></p></li></ul><h2><a class="tc-tiddlylink tc-tiddlylink-missing" href="ChangeLog.html">ChangeLog</a></h2><ul><li><p>2019-05-11 update 15m</p></li><li><p>2019-04-23 init 2h</p></li></ul></div>



</div>

</p>
</section>
</body>
</html>
