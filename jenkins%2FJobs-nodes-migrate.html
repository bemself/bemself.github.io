<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="generator" content="TiddlyWiki" />
<meta name="tiddlywiki-version" content="5.1.22" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="format-detection" content="telephone=no">
<link id="faviconLink" rel="shortcut icon" href="favicon.ico">
<link rel="stylesheet" href="static.css">
<title>jenkins/Jobs-nodes-migrate: My Struggle — Life goes on...</title>
</head>
<body class="tc-body">

<section class="tc-story-river">
<p><div class="tc-tiddler-frame tc-tiddler-view-frame tc-tiddler-exists " data-tags="" data-tiddler-title="jenkins/Jobs-nodes-migrate"><div class="tc-tiddler-title"><div class="tc-titlebar"><span class="tc-tiddler-controls"><span class=" tc-reveal"><button aria-label="more" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fmore-tiddler-actions" title="More actions"></button><div class=" tc-reveal" hidden="true"></div></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal"><button aria-label="edit" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fedit" title="Edit this tiddler"></button></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal"><button aria-label="close" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fclose" title="Close this tiddler"></button></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span></span><span><span class="tc-tiddler-title-icon" style="fill:;"></span><h2 class="tc-title">jenkins/Jobs-nodes-migrate</h2></span></div><div class="tc-tiddler-info tc-popup-handle tc-reveal" hidden="true"></div></div><div class=" tc-reveal" hidden="true"></div>
<div class=" tc-reveal"><div class="tc-subtitle"><a class="tc-tiddlylink tc-tiddlylink-missing" href=".html"></a>26th July 2020</div></div><div class=" tc-reveal">
<div class="tc-tags-wrapper"></div>
</div>

<div class="tc-tiddler-body tc-reveal"><hr><p>title: Jenkins - Migrate Jenkins Jobs and Nodes<br>edit: 2018-08-11<br>layout: post<br>categories:</p><ul><li><p>Python<br>tags:</p></li><li><p>Python<br>description: Jenkins持续集成，实现在两个Jenkins服务器间迁移Jobs和Nodes</p></li></ul><hr><h2>Background</h2><p>We need to migrate our Jenkins jobs and nodes from old Jenkins server to a new one.</p><p>Jenkins itself has a very convenient way to do this, by simply copying the job's config.xml, and a reload or restart of the Jenkins server will automatically has the job generated.</p><p>The problem is, there are many build histories for each job on the old server, we'd prefer a migrate without histories.</p><p>Thus need a way to extract all the config.xml file from each job.</p><h2>Analysis</h2><p>We can iterate the Jenkins jobs folder on the old server, copy out the config.xml onto a shared network place.</p><p>Then copy all to the new Jenkins server. Find the details in the Solutions section</p><p>Another way to think, with the aim of using Jenkins API (for future development) and purely out of learning purpose, we can make the solution a bit more complicated, this will be discussed in the Go Further section</p><h2>Solution</h2><ol><li><p>define a function to extract specified config.xml file from the source folder. This folder is like <code>&lt;jenkins server root&gt;\jobs\&lt;jobname&gt;</code>, config.xml is directly under it.</p><p>since we don't need to walk through all subfolders, so we use <code>next(os.walk(src))[1]</code> to get all the direct child of source folder.</p></li></ol><pre><code>from shutil import copy2
def extract_config_files(src, target):
    for dir in next(os.walk(src))[1]:
        temp_target = os.path.join(target, dir)
        if not os.path.exists(temp_target):
            os.mkdir(temp_target)
        copy2(os.path.join(src, dir, &quot;config.xml&quot;), temp_target)
</code></pre><ol><li><p>Connect both servers using NET USE command, and call the above extract function. Close the connection in the end</p><pre><code>old_jenkins_server = &quot;&lt;old server&gt;&quot;
new_jenkins_server = &quot;&lt;new server&gt;&quot;&quot;

subprocess.call(r&quot;NET USE %s %s /USER:%s\%s&quot; % (r&quot;\\%s&quot; % old_jenkins_server, &quot;&lt;password&gt;&quot;, &quot;domainname&quot;, &quot;username&quot;))
subprocess.call(r&quot;NET USE %s %s /USER:%s\%s&quot; % (r&quot;\\%s&quot; % new_jenkins_server, &quot;&lt;password&gt;&quot;, &quot;domainname&quot;, &quot;username&quot;))

src = r&quot;\\%s\c$\Jenkins\jobs&quot; % old_jenkins_server
target= r&quot;\\%s\c$\temp&quot; % new_jenkins_server

extract_config_files(src, target)

subprocess.call(r&quot;NET USE \\%s /DELETE&quot; % new_jenkins_server)
subprocess.call(r&quot;NET USE \\%s /DELETE&quot; % old_jenkins_server)
</code></pre><p>​</p></li></ol><h2>Go Further</h2><p>Now to train ourselves with more Jenkins knowledge, we use another solution to solve the same problem. But remember in real case, always use the one that cost less and get things done quickly.</p><p>To do this, we use <a href="https://github.com/salimfadhley/jenkinsapi" target="_blank">Jenkins Python api</a>, there are also other similar apis, but this one is more convenient for me.</p><p>Planned Steps for migrating Jobs:</p><ul><li><p>Connect with old server</p><pre><code>from jenkinsapi.jenkins import Jenkins
old_server_url = &quot;http://%s:8080/&quot; % old_server_ip
old_server = Jenkins(old_server_url)
</code></pre></li></ul><ul><li><p>Get all the job list from old server</p></li></ul><p>simply call the api's get_jobs function, this will return a dictionary</p><pre><code>jobs = old_server.get_jobs()
</code></pre><ul><li><p>Copy all the job config files from old server to a shared place</p></li></ul><pre><code>def backup_files(src, target):
    copy2(src.decode(&quot;utf-8&quot;), target.decode(&quot;utf-8&quot;))
    
def backup_job_configs(jobs, src, target):
    for job in jobs:
        jobname, job_obj = job
        src = os.path.join(src_root, &quot;jobs&quot;, jobname, &quot;config.xml&quot;).encode(&quot;utf-8&quot;)
        target_path = os.path.join(target_root, &quot;jobs&quot;, jobname)
        if not os.path.exists(target_path):
            os.mkdir(target_path)
        target = os.path.join(target_path, &quot;config.xml&quot;).encode(&quot;utf-8&quot;)
        backup_files(src, target)
</code></pre><ul><li><p>Create new jobs on new server from the config files</p></li></ul><pre><code>def create_new_job(server, jobname, xml):
    with open(xml, encoding=&quot;utf-8&quot;) as file:
        config = file.read()

def create_jobs(server, jobs, xml_path):
    for job in jobs:
        try:
            jobname, _ = job
            if not job_created(server, jobname):
                create_new_job(server, jobname, os.path.join(os.path.join(xml_path, &quot;jobs&quot;,), jobname + &quot;_config.xml&quot;))
                if job_created(server, jobname):
                    print(f&quot;{jobname} is created successful&quot;)
                else:
                    print(f&quot;{jobname} is NOT created&quot;)
        except Exception as e:
            print(jobname.encode(&quot;utf-8&quot;), &quot;fail with error: &quot;, e.__str__().encode(&quot;utf-8&quot;))
            continue
</code></pre><p>Now new jobs are created on the new Jenkins server.</p><p>Same can be applied to Nodes.</p><ul><li><p>Get all nodes from the old server</p></li></ul><pre><code>nodes = old_server.get_nodes()
</code></pre><ul><li><p>Create nodes on the new server</p><pre><code>def create_nodes(server, nodes):
    for key, value in nodes.iteritems():
         if key != &quot;master&quot;:
             server.create_node(key , remote_fs='c:\jenkins', num_executors=1)
</code></pre></li><li><p>you can also delete nodes if something gets wrong and you want to start over</p></li></ul><pre><code>def delete_nodes(new_server):
    nodes = new_server.get_nodes()
    for key, value in nodes.iteritems():
         if key != &quot;master&quot;:
             new_server.delete_node(key )
</code></pre><p>To be continued</p><h2>To Go Even Further</h2><ul><li><p>Encoding issue</p></li></ul></div>



</div>

</p>
</section>
</body>
</html>
