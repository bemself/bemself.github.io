<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="generator" content="TiddlyWiki" />
<meta name="tiddlywiki-version" content="5.1.22" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="format-detection" content="telephone=no">
<link id="faviconLink" rel="shortcut icon" href="favicon.ico">
<link rel="stylesheet" href="static.css">
<title>python/Logging: My Struggle — Life goes on...</title>
</head>
<body class="tc-body">

<section class="tc-story-river">
<p><div class="tc-tiddler-frame tc-tiddler-view-frame tc-tiddler-exists " data-tags="" data-tiddler-title="python/Logging"><div class="tc-tiddler-title"><div class="tc-titlebar"><span class="tc-tiddler-controls"><span class=" tc-reveal"><button aria-label="more" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fmore-tiddler-actions" title="More actions"></button><div class=" tc-reveal" hidden="true"></div></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal"><button aria-label="edit" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fedit" title="Edit this tiddler"></button></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal"><button aria-label="close" class="tc-btn-invisible tc-btn-%24%3A%2Fcore%2Fui%2FButtons%2Fclose" title="Close this tiddler"></button></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span><span class=" tc-reveal" hidden="true"></span></span><span><span class="tc-tiddler-title-icon" style="fill:;"></span><h2 class="tc-title">python/Logging</h2></span></div><div class="tc-tiddler-info tc-popup-handle tc-reveal" hidden="true"></div></div><div class=" tc-reveal" hidden="true"></div>
<div class=" tc-reveal"><div class="tc-subtitle"><a class="tc-tiddlylink tc-tiddlylink-missing" href=".html"></a>26th July 2020</div></div><div class=" tc-reveal">
<div class="tc-tags-wrapper"></div>
</div>

<div class="tc-tiddler-body tc-reveal"><hr><p>title:  Python Logging 日志输出到文件<br>date:  2020-05-03 21:01:18<br>edit:  2020-05-03 21:01:05<br>layout: post<br>status: Writing<br>categories:</p><ul><li><p>Python<br>tags:</p></li><li><p>Python<br>description:  使用日志配置文件, 输出 log 到文件</p></li></ul><hr><h1>背景</h1><p>了解如何使用 python logging, 输出日志到文件中.</p><p>并初步结合 flask 框架以及多模块的环境配置, 尚不太成熟, 待改进</p><p>至于为什么要用 logging, 而不是之前的 print, 原因也简单, logging 的信息量更大, 如果输出到文件中也更方便.</p><h1>Python Logging 碎碎念之配置文件</h1><p>python 有自带的 logging 模块, 足够用了, 也挺好用.</p><p>用前先想想:</p><ul><li><p>要能兼顾所有模块</p></li><li><p>要有时间戳</p></li><li><p>要方便配置, 比如更改 log文件名, log level 等</p><ul><li><p>文件名不写死在代码中...</p></li></ul></li><li><p>...</p></li></ul><p>自然需要外置 conf 配置文件.</p><p>当然, 外置 conf 文件虽然配置起来方便, 但要在代码中操控它就有点麻烦, 不过从用户角度看, 这个还是首选. 具体的 pro 和 cons 请参考<a href="https://docs.python-guide.org/writing/logging/" target="_blank">Logging — The Hitchhiker's Guide to Python</a></p><p>那:</p><ul><li><p>conf 文件格式有什么要求?</p></li><li><p>conf 文件内容怎么写?</p></li><li><p>conf 文件怎么读?</p></li></ul><p>文件格式一般有几种:</p><ul><li><p>ini 文件: 类似 key=value</p></li><li><p>yml 文件</p></li><li><p>json 文件</p></li></ul><p>对他们的解析不一样, 读取的时候用到的模块:</p><ul><li><p>ini 文件: <code>logging.config.fileConfg</code></p></li><li><p>yml/json 文件: <code>logging.config.dictConfig</code></p></li></ul><p>示例见下节</p><p>文件内容怎么写?</p><p>一般比较重要的得包含:</p><ul><li><p>level: debug/info/warn...</p></li><li><p>handlers</p><ul><li><p>file handler</p><ul><li><p>file name: 比如带时间戳等</p></li></ul></li><li><p>console handler</p></li></ul></li><li><p>formatters</p><ul><li><p>file formatter</p></li><li><p>console formatter</p></li></ul></li></ul><p>简单的示例如下, 详细示例请见文末的附录</p><pre><code>[logger_root]
level=DEBUG
handlers=fileHandler

[handler_fileHandler]
class=FileHandler
level=DEBUG
formatter=logFormatter
args=(&quot;_log/&quot; + time.strftime(&quot;%%Y%%m%%d%%H%%M%%S&quot;)+'.log', 'a')

[formatter_logFormatter]
format=%(asctime)s | %(levelname)-8s | %(lineno)04d | %(message)s
</code></pre><h1>在代码中加载 log 配置文件</h1><p>加载 yml/json 文件:</p><pre class="py hljs"><code><span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">import</span> logging.config.dictConfig(yaml.load(open(<span class="hljs-string">'logging.yml'</span>, Loader=yaml.FullLoader))))
</code></pre><p>加载 .ini 文件</p><pre class="py hljs"><code><span class="hljs-keyword">import</span> logging
logging.config.fileConfig(<span class="hljs-string">"logging.ini"</span>)
</code></pre><h1>在模块中使用就很简单了,</h1><pre class="py hljs"><code>logger = logging.getLogger(__name__)
logger.debug(<span class="hljs-string">"log %s"</span>, it)
</code></pre><p>当然这只是很简单的场景, 实际应用中会需要用到 filter, 更改文件名, 获取 log 文件名等等</p><p>比如, 我想在程序运行结束的时候把 log 文件地址也输出到 log 文件中, 然而却发现有点难度, 试了几种方法, 只成功了下面这个:</p><pre class="py hljs"><code>LOG_FILE = logging.getLoggerClass().root.handlers[<span class="hljs-number">0</span>].baseFilename
logger = logging.getLogger(__name__)
logger.debug(<span class="hljs-string">f"LOG_FILE: , <span class="hljs-subst">{LOG_FILE}</span>"</span>)
</code></pre><p>未成功之一: 我拿到的 handlers list 总是为空...</p><pre class="py hljs"><code><span class="hljs-keyword">import</span> logging
dir(logging.FileHandler)
<span class="hljs-meta">&gt;&gt;&gt; </span>handler = job_logger.handlers[<span class="hljs-number">0</span>]
<span class="hljs-meta">&gt;&gt;&gt; </span>filename = handler.baseFilename
<span class="hljs-meta">&gt;&gt;&gt; </span>print(filename)
<span class="hljs-string">'/tmp/test_logging_file'</span>
</code></pre><h1>还想输出 exception details</h1><p>先在需要处理 exception 的地方 raise exception</p><pre><code>raise Exception(msg)
</code></pre><p>然后, catch 的时候输出到 log 中</p><pre class="py hljs"><code><span class="hljs-keyword">import</span> traceback
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    msg = traceback.from_exec()
    logger.debug(msg)
</code></pre><p>注意, 这里的 form_exec() 是不带参数的</p><p>我之前忽略了, 想当然的加了 e 作为参数, 结果错误: <code>'&gt;=' not supported between instances of 'Exception' and 'int'</code></p><h1>Flask Logging</h1><p>如果代码中用到了 flask 框架, 如何输出 log 呢?</p><p>同样, 重用前面的 log 配置, 在 app.py 中直接用 app.logger 即可, 底层用的还是 python logging 模块</p><pre><code>app = create_app()
logger = app.logger
</code></pre><h1>Reference</h1><h2>Python logging</h2><ul><li><p><a href="https://docs.python.org/3/library/logging.html" target="_blank">logging — Logging facility for Python — Python 3.8.3rc1 documentation</a></p></li><li><p><a href="https://docs.python-guide.org/writing/logging/" target="_blank">Logging — The Hitchhiker's Guide to Python</a></p></li></ul><h2>flask logging</h2><p><a href="https://flask.palletsprojects.com/en/1.1.x/logging/" target="_blank">Logging — Flask Documentation (1.1.x)</a></p><h1>附录: 大致的目录结构</h1><p>log 配置文件的读取是在 module2/<strong>init</strong>.py 中;</p><pre class="py hljs"><code><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> logging
<span class="hljs-keyword">from</span> logging.config <span class="hljs-keyword">import</span> fileConfig

<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(<span class="hljs-string">"_log"</span>):
    os.mkdir(<span class="hljs-string">"_log"</span>)
logging.config.fileConfig(<span class="hljs-string">"logging.conf"</span>))
LOG_FILE = logging.getLoggerClass().root.handlers[<span class="hljs-number">0</span>].baseFilename
logger = logging.getLogger(__name__)
logger.debug(<span class="hljs-string">f"LOG_FILE: , <span class="hljs-subst">{LOG_FILE}</span>"</span>)
</code></pre><p>main.py 启动 flask app</p><pre><code>.root
├── logging.conf
├── logging.yml
├── main.py
├── README.md
├── _log
            └── 20200503204102.log
├── module1
            ├── __init__.py
            ├── requirements.txt
            ├── src
            │   ├── __init__.py
            │   └── app.py
            └── test
└── module2
            ├── __init__.py
            ├── src
                        ├── __init__.py
            └── test
                        ├── __init__.py
            ├── requirements.txt
            ├── README.md
            ├── data
            ├── docs
            ├── invoke.yml
</code></pre><h1>附录: logging.ini sample (摘自网络),</h1><p>因为带了注释, 所以摘录在此供参考:</p><p>如需 yml 文件, 可参考<a href="https://stackoverflow.com/questions/17743019/flask-logging-cannot-get-it-to-write-to-a-file" target="_blank">python - Flask logging - Cannot get it to write to a file - Stack Overflow</a></p><pre class="ini hljs"><code><span class="hljs-comment">#These are the loggers that are available from the code</span>
<span class="hljs-comment">#Each logger requires a handler, but can have more than one</span>
<span class="hljs-section">[loggers]</span>
<span class="hljs-attr">keys</span>=root,Admin_Client

<span class="hljs-comment">#Each handler requires a single formatter</span>
<span class="hljs-section">[handlers]</span>
<span class="hljs-attr">keys</span>=fileHandler, consoleHandler

<span class="hljs-section">[formatters]</span>
<span class="hljs-attr">keys</span>=logFormatter, consoleFormatter

<span class="hljs-section">[logger_root]</span>
<span class="hljs-attr">level</span>=DEBUG
<span class="hljs-attr">handlers</span>=fileHandler

<span class="hljs-section">[logger_Admin_Client]</span>
<span class="hljs-attr">level</span>=DEBUG
<span class="hljs-attr">handlers</span>=fileHandler, consoleHandler
<span class="hljs-attr">qualname</span>=Admin_Client
<span class="hljs-comment">#propagate=0 Does not pass messages to ancestor loggers(root)</span>
<span class="hljs-attr">propagate</span>=<span class="hljs-number">0</span>

<span class="hljs-comment"># Do not use a console logger when running scripts from a bat file without a console</span>
<span class="hljs-comment"># because it hangs!</span>
<span class="hljs-section">[handler_consoleHandler]</span>
<span class="hljs-attr">class</span>=StreamHandler
<span class="hljs-attr">level</span>=DEBUG
<span class="hljs-attr">formatter</span>=consoleFormatter
<span class="hljs-attr">args</span>=(sys.stdout,)<span class="hljs-comment"># The comma is correct, because the parser is looking for args</span>

<span class="hljs-section">[handler_fileHandler]</span>
<span class="hljs-attr">class</span>=FileHandler
<span class="hljs-attr">level</span>=DEBUG
<span class="hljs-attr">formatter</span>=logFormatter
<span class="hljs-comment"># This causes a new file to be created for each script</span>
<span class="hljs-comment"># Change time.strftime("%Y%m%d%H%M%S") to time.strftime("%Y%m%d")</span>
<span class="hljs-comment"># And only one log per day will be created. All messages will be amended to it.</span>
<span class="hljs-attr">args</span>=(<span class="hljs-string">"_log/"</span> + time.strftime(<span class="hljs-string">"%%Y%%m%%d%%H%%M%%S"</span>)+<span class="hljs-string">'.log'</span>, <span class="hljs-string">'a'</span>)

<span class="hljs-section">[formatter_logFormatter]</span>
<span class="hljs-comment">#name is the name of the logger root or Admin_Client</span>
<span class="hljs-comment">#levelname is the log message level debug, warn, ect </span>
<span class="hljs-comment">#lineno is the line number from where the call to log is made</span>
<span class="hljs-comment">#04d is simple formatting to ensure there are four numeric places with leading zeros</span>
<span class="hljs-comment">#4s would work as well, but would simply pad the string with leading spaces, right justify</span>
<span class="hljs-comment">#-4s would work as well, but would simply pad the string with trailing spaces, left justify</span>
<span class="hljs-comment">#filename is the file name from where the call to log is made</span>
<span class="hljs-comment">#funcName is the method name from where the call to log is made</span>
<span class="hljs-comment">#format=%(asctime)s | %(lineno)d | %(message)s</span>
<span class="hljs-comment">#format=%(asctime)s | %(name)s | %(levelname)s | %(message)s</span>
<span class="hljs-comment">#format=%(asctime)s | %(name)s | %(module)s-%(lineno) | %(levelname)s | %(message)s</span>
<span class="hljs-comment">#format=%(asctime)s | %(name)s | %(module)s-%(lineno)04d | %(levelname)s | %(message)s</span>
<span class="hljs-comment">#format=%(asctime)s | %(name)s | %(module)s-%(lineno)4s | %(levelname)-8s | %(message)s</span>
<span class="hljs-attr">format</span>=%(asctime)s | %(levelname)-<span class="hljs-number">8</span>s | %(line<span class="hljs-literal">no</span>)<span class="hljs-number">04</span>d | %(message)s

<span class="hljs-comment">#Use a separate formatter for the console if you want</span>
<span class="hljs-section">[formatter_consoleFormatter]</span>
<span class="hljs-attr">format</span>=%(asctime)s | %(levelname)-<span class="hljs-number">8</span>s | %(filename)s-%(funcName)s-%(line<span class="hljs-literal">no</span>)<span class="hljs-number">04</span>d | %(message)s
</code></pre><h1><a class="tc-tiddlylink tc-tiddlylink-missing" href="ChangeLog.html">ChangeLog</a></h1><ul><li><p>2020-05-03 init</p></li></ul></div>



</div>

</p>
</section>
</body>
</html>
